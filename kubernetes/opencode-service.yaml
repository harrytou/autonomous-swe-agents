apiVersion: v1
kind: Service
metadata:
  name: opencode-server
  labels:
    app: opencode
    component: server
spec:
  type: ClusterIP
  selector:
    app: opencode
    component: server
  ports:
    - name: http
      port: 4000
      targetPort: 4000
      protocol: TCP
---
# Optional: NodePort Service for external access without Ingress
# Uncomment this section if you need direct NodePort access
# apiVersion: v1
# kind: Service
# metadata:
#   name: opencode-server-nodeport
#   labels:
#     app: opencode
#     component: server
# spec:
#   type: NodePort
#   selector:
#     app: opencode
#     component: server
#   ports:
#     - name: http
#       port: 4000
#       targetPort: 4000
#       nodePort: 30400  # NodePort range: 30000-32767
#       protocol: TCP
---
# Optional: LoadBalancer Service for cloud environments
# Uncomment this section if running on cloud providers (AWS, GCP, Azure)
# apiVersion: v1
# kind: Service
# metadata:
#   name: opencode-server-lb
#   labels:
#     app: opencode
#     component: server
#   annotations:
#     # AWS-specific annotations (uncomment if using AWS)
#     # service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
#     # service.beta.kubernetes.io/aws-load-balancer-internal: "true"
#     
#     # GCP-specific annotations (uncomment if using GCP)
#     # cloud.google.com/load-balancer-type: "Internal"
#     
#     # Azure-specific annotations (uncomment if using Azure)
#     # service.beta.kubernetes.io/azure-load-balancer-internal: "true"
# spec:
#   type: LoadBalancer
#   selector:
#     app: opencode
#     component: server
#   ports:
#     - name: http
#       port: 4000
#       targetPort: 4000
#       protocol: TCP
---
# Ingress for external HTTP/HTTPS access
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: opencode-server-ingress
  labels:
    app: opencode
    component: server
  annotations:
    # Nginx Ingress Controller annotations
    nginx.ingress.kubernetes.io/proxy-body-size: "100m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    # Enable websocket support for real-time communication
    nginx.ingress.kubernetes.io/websocket-services: "opencode-server"
    # Uncomment for TLS with cert-manager
    # cert-manager.io/cluster-issuer: "letsencrypt-prod"
spec:
  ingressClassName: nginx  # Change to your ingress class if different
  rules:
    - host: opencode.example.com  # Replace with your domain
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: opencode-server
                port:
                  number: 4000
  # Uncomment for TLS/HTTPS
  # tls:
  #   - hosts:
  #       - opencode.example.com
  #     secretName: opencode-tls-secret
